<!-- Ant build file - Needs Ant v1.6.x or later -->
<project name="miradi" default="release" basedir="../../">
    <description>
        Miradi Build File
    </description>
	
	<!-- product version -->
	<!-- NOTE: Remember to change install4j version too! -->
	<property name="version.prefix" value=""/>
	<property name="version.main" value = "4.2"/>
	<property name="version.minor" value = ".0"/>
	<property name="version.full" value="${version.main}${version.minor}"/>
	<property name="version.langpack" value="${version.main}" />
  
	<property environment="env"/>

    <!-- env vars from build machine -->
    <property name="mac.build.user" value="${env.SITKA.MAC.BUILDUSER}" />
    <property name="mac.build.server" value="${env.SITKA.MAC.BUILDSERVER}" />
    <property name="mac.build.password" value="${env.SITKA.MAC.BUILDPASSWORD}" />
    <property name="mac.build.certname" value="${env.SITKA.MAC.BUILDCERT}" />
    <property name="source.hg.username" value="${env.HG.USER}"/>
    <property name="source.hg.password" value="${env.HG.PASSWORD}"/>
    <property name="jenkins.workspace" value="${env.WORKSPACE}"/>

    <!-- repos -->
    <property name="source.hg.miradi-client" value="https://code.google.com/p/miradi-client/"/>
    <property name="source.hg.miradi-client-thirdparty" value="https://code.google.com/p/miradi-client-thirdparty/"/>

	<!-- directories -->
	<property name="build.dir" value="${jenkins.workspace}/build"/>
    <property name="dist.dir" value="${jenkins.workspace}/../miradi-client-dist"/>

    <property name="dist.temp" value="${dist.dir}/temp"/>
    <property name="dist.temp.jars" value="${dist.temp}/jars"/>
    <property name="dist.temp.third-party" value="${dist.temp}/miradi-client-thirdparty"/>
	
	<property name="translations.subdir" value="translations"/>
    
	<property name="miradi.root.dir" value="${jenkins.workspace}" />
    <property name="eam.src.root" value="${jenkins.workspace}/source"/>
    <property name="eam.test.src.root" value="${jenkins.workspace}/tests"/>
    <property name="eam.class.root" value="${dist.temp}/bin"/>
    <property name="eam.test.class.root" value="${dist.temp}/testbin"/>
	<property name="eam.thirdparty" value="${dist.temp.jars}"/>
	<property name="eam.resources" value="${eam.src.root}/resources" />
	<property name="eam.icons" value="${eam.resources}/icons" />
	<property name="eam.fieldlabels.properties" value="${eam.resources}/FieldLabels.properties"/>
	<property name="eam.translations.dir" value = "${eam.src.root}/${translations.subdir}"/>
    
    <property name="translations.dir" value="${jenkins.workspace}/${translations.subdir}" />

	<property name="version.file" value = "${dist.dir}/miradi.version.txt" />
	<property name="timestamp.file" value = "${dist.dir}/miradi.timestamp.txt" />

	<!-- third-party jars -->
	<property name="browserlauncher.jar" value="${dist.temp.jars}/BrowserLauncher2/BrowserLauncher2-all-10rc4.jar"/>
	<property name="commons-lang3.jar" value="${dist.temp.jars}/commons-lang3/3.1/commons-lang3-3.1.jar"/>
	<property name="miradi-jgraph.jar" value="${dist.temp.jars}/jgraph/miradi-jgraph-5.12.2.2b.jar"/>
	<property name="jcalendar.jar" value="${dist.temp.jars}/jcalendar-1.3.2/jcalendar-1.3.2.jar"/>
	<property name="jing.jar" value="${dist.temp.jars}/jing/bin/jing.jar" />
	<property name="martus-swing.jar" value="${dist.temp.jars}/martus-swing/bin/martus-swing.jar" />
	<property name="martus-utils.jar" value="${dist.temp.jars}/martus-utils/bin/martus-utils.jar" />
	<property name="swingx.jar" value="${dist.temp.jars}/swingx/0.9.7/swingx-0.9.7.jar" />
	<property name="jortho.jar" value="${dist.temp.jars}/jortho/bin/jortho.jar" />
	<property name="shef.jar" value="${dist.temp.jars}/shef/0.5/shef.jar" />
	<property name="sam.jar" value="${dist.temp.jars}/shef/0.5/sam.jar" />
	<property name="jtidy.jar" value="${dist.temp.jars}/shef/0.5/jtidy-8.0.jar" />
	<property name="junit.jar" value="${dist.temp.jars}/JUnit/bin/junit.jar" />

	<!-- classpath -->
    <path id="eam.class.path">
        <pathelement path="${eam.class.root}/"/>
        <pathelement path="${eam.test.class.root}/"/>
        <pathelement path="${martus-swing.jar}/"/>
        <pathelement path="${martus-utils.jar}/"/>
		<pathelement path="${browserlauncher.jar}"/>
    	<pathelement path="${commons-lang3.jar}"/>
		<pathelement path="${miradi-jgraph.jar}"/>
    	<pathelement path="${jcalendar.jar}"/>
    	<pathelement path="${jing.jar}"/>
    	<pathelement path="${swingx.jar}"/>
    	<pathelement path="${jortho.jar}"/>
    	<pathelement path="${shef.jar}"/>
    	<pathelement path="${sam.jar}"/>
    	<pathelement path="${jtidy.jar}"/>
    	<pathelement path="${junit.jar}"/>
     </path>
    
    <!-- defined values -->
	<property name="installer.top" value="${build.dir}/installer"/>
	<property name="installer.win32" value="${installer.top}/Win32_NSIS/"/>
	<property name="installer.buildfiles.dir" value="${installer.top}/BuildFiles"/>
    <property name="installer.src" value="${installer.win32}"/>
    <property name="installer.bin" value="${installer.win32}/bin"/>
	<property name="installer.mac.dir" value="${installer.top}/Mac" />
	<property name="installer.mac.dmgbuild.dir" value="${installer.mac.dir}/dmgbuild" />

	<property name="samples.marine.miradi" value="MarineExample.Miradi"/>
	
	<property name="dist.mactree" value="${dist.dir}/MiradiMacInstall" />
	<property name="mac.app.name" value="Miradi-${version.full}" />
	<condition property="nsis.executable" value="makensis.exe" else="makensis">
		<os family="windows"/>
	</condition>

	<!-- translations -->
	<property name="miradi.pot" value="${dist.dir}/miradi-${version.langpack}.pot" />
    <property name="miradi.po.de" value="${translations.dir}/miradi_de.po" />
    <property name="miradi.po.es" value="${translations.dir}/miradi_es.po" />
    <property name="miradi.po.fr" value="${translations.dir}/miradi_fr.po" />
    <property name="miradi.po.he" value="${translations.dir}/miradi_he.po" />
    <property name="miradi.po.hu" value="${translations.dir}/miradi_hu.po" />
    <property name="miradi.po.id" value="${translations.dir}/miradi_id.po" />
    <property name="miradi.po.it" value="${translations.dir}/miradi_it.po" />
    <property name="miradi.po.mn" value="${translations.dir}/miradi_mn.po" />
    <property name="miradi.po.plt" value="${translations.dir}/miradi_plt.po" />
    <property name="miradi.po.pt" value="${translations.dir}/miradi_pt.po" />
    <property name="miradi.po.psp" value="${translations.dir}/miradi_psp.po" />
    <property name="miradi.po.uk" value="${translations.dir}/miradi_uk.po" />
    <property name="miradi.po.zh" value="${translations.dir}/miradi_zh.po" />
    <property name="miradi.po.aid" value="${translations.dir}/miradi_aid.po" />

<!-- ================================================================== -->
<!-- I N I T                                                            -->
<!-- ================================================================== -->
<target name="init" description="Initialize build number, timestamp and version">
    <tstamp>
        <format property="version.timestamp" pattern="yyyy-MM-dd HH:mm:ss"/>
    </tstamp>

    <tstamp/>

    <echo message="Date timestamp is ${DSTAMP}" />
    <echo message="Time timestamp is ${TSTAMP}" />
    <echo message="Version timestamp is ${version.timestamp}" />

    <fail message="env.WORKSPACE is not defined" unless="env.WORKSPACE"/>
    <echo message="env.WORKSPACE = ${env.WORKSPACE}"/>

    <fail message="env.JAVA6.BOOT.CLASSPATH is not defined" unless="env.JAVA6.BOOT.CLASSPATH"/>
    <echo message="env.JAVA6.BOOT.CLASSPATH = ${env.JAVA6.BOOT.CLASSPATH}"/>

    <fail message="env.INSTALL4J.INSTALL.PATH is not defined" unless="env.INSTALL4J.INSTALL.PATH"/>
    <echo message="env.INSTALL4J.INSTALL.PATH = ${env.INSTALL4J.INSTALL.PATH}"/>

    <fail message="env.INSTALL4J.JRES.PATH is not defined" unless="env.INSTALL4J.JRES.PATH"/>
    <echo message="env.INSTALL4J.JRES.PATH = ${env.INSTALL4J.JRES.PATH}"/>

    <!-- TODO: this should be replaced by isBuildServer or similar... -->
    <condition property="isLinux">
        <and>
            <os family="unix"/>
            <not>
                <os family="mac"/>
            </not>
        </and>
    </condition>

    <mkdir dir='${dist.dir}' />
    <mkdir dir='${dist.temp.jars}' />

    <echo file="${version.file}" append="false" message="${version.prefix}${version.full}"/>
    <echo file="${timestamp.file}" append="false" message="${version.timestamp}"/>
</target>

<!-- ================================================================== -->
<!-- C L E A N                                                          -->
<!-- ================================================================== -->
<target name="clean" description="Remove all class files and jars">
<delete dir="${dist.dir}"/>
</target>

<!-- ================================================================== -->
<!-- CLEANUP                                                          -->
<!-- ================================================================== -->
<target name="cleanup" description="Delete temp files">
<delete dir="${dist.temp}"/>
</target>

<!-- ================================================================== -->
<!-- B U I L D                                                          -->
<!-- ================================================================== -->
<target name="build" depends="init, ThirdParty" description="Compile Miradi">
<mkdir dir="${eam.class.root}"/>

<javac source="1.6" target="1.6" compiler="javac1.7" optimize="on" failonerror="true"
        includeantruntime="false"
        debug="true" debuglevel="lines,source"
        srcdir="${eam.src.root}" destdir="${eam.class.root}"
        bootclasspath="${env.JAVA6.BOOT.CLASSPATH}" >
    <compilerarg value="-Xlint:unchecked" />
    <compilerarg value="-Werror" />
    <classpath refid="eam.class.path"/>
    <include name="**/*.java"/>
</javac>

</target>

<!-- ================================================================== -->
<!-- T E S T                                                            -->
<!-- ================================================================== -->
<target name="test" depends="init, build" description="Run unit tests">
<mkdir dir="${eam.test.class.root}"/>
<javac source="1.6" target="1.6" compiler="javac1.6" optimize="on" failonerror="true"
        srcdir="${eam.test.src.root}" destdir="${eam.test.class.root}" >
    <compilerarg value="-Xlint:unchecked" />
    <classpath refid="eam.class.path"/>
    <classpath location='${junit.jar}' />
    <include name="**/*.java"/>
</javac>

<copy todir="${eam.test.class.root}/resources">
    <fileset dir="${eam.resources}" />
</copy>
<copy todir="${eam.test.class.root}/translations">
    <fileset dir="${eam.test.src.root}/translations" />
</copy>
<copy todir="${eam.test.class.root}">
    <fileset dir="${eam.src.root}">
        <include name="**/*.txt" />
    </fileset>
</copy>
<copy todir="${eam.test.class.root}">
    <fileset dir="${eam.test.src.root}">
        <include name="**/*.xls" />
        <include name="**/*.mpz" />
        <include name="**/*.Miradi" />
    </fileset>
</copy>

<!--
<java classname='org.miradi.main.MainTests'>
    <classpath refid='eam.class.path' />
    <classpath>
        <pathelement location='${eam.test.class.root}' />
        <pathelement location='${eam.class.root}' />
        <pathelement location='/work/benetech/miradi3/eclipse/miradi-thirdparty/JUnit/bin/junit.jar' />
    </classpath>
</java>
-->
<junit haltonfailure='on' showoutput='on'>
    <classpath location='${junit.jar}' />
    <classpath refid='eam.class.path' />
    <classpath location='${eam.class.root}' />

    <test name='org.miradi.main.MainTests' todir='${eam.test.class.root}' />
<!--
    <batchtest fork="yes">
        <fileset dir="${eam.test.src.root}">
            <include name="**/Test*.java"/>
            <exclude name="**/MainTests.java"/>
        </fileset>
    </batchtest>
-->

    <formatter type="plain" />

</junit>
</target>

<!-- ================================================================== -->
<!-- J A R                                                          -->
<!-- ================================================================== -->
<target name="jar" depends="test" description="Create jar">
        <mkdir dir="${dist.dir}"/>
        <jar destfile="${dist.dir}/miradi.jar">
          	<manifest>
          		<attribute name="main-class" value="org.miradi.main.Miradi"/>
          	</manifest>
            <fileset dir="${eam.class.root}" includes="**/*.class"/>
            <fileset dir="${eam.src.root}" includes="resources/**/*" />
            <fileset dir="${eam.src.root}" includes="org/miradi/xml/**/*.txt" />
        	<fileset dir="${dist.dir}" includes="*.txt" />
        </jar>
</target>

<!-- ================================================================== -->
<!-- DOWNLOAD FROM THIRD PARTY REPO                                     -->
<!-- ================================================================== -->
<target name="copy-thirdparty">
	<property name='dir' value='${dist.temp.jars}/${directory}' />
	<property name='from' value='${dist.temp.third-party}/${directory}/${filename}' />
	<mkdir dir='${dir}' />
    <copy file="${from}" todir="${dir}" />
</target>

<target name="clean-thirdparty">
    <echo message="Deleting ${dist.temp.third-party}" />
    <delete dir="${dist.temp.third-party}"/>
</target>

<target name="get-thirdparty" depends="clean-thirdparty">
    <echo message="Cloning source from ${source.hg.miradi-client-thirdparty} to ${dist.temp}" />
    <mkdir dir='${dist.temp}' />
    <exec executable="hg" failonerror="true" dir="${dist.temp}">
        <arg value="clone" />
        <arg value="${source.hg.miradi-client-thirdparty}" />
    </exec>
</target>

<!-- ================================================================== -->
<!-- THIRD-PARTY JARS, SOURCE, LICENSES                                 -->
<!-- ================================================================== -->
<target name='ThirdParty' depends='get-thirdparty' description='Download third-party jars'>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='BrowserLauncher2' />
		<param name='filename' value='BrowserLauncher2-all-10rc4.jar' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='BrowserLauncher2' />
		<param name='filename' value='License.BrowserLauncher2' />
	</antcall>
	<move file="${dist.temp.jars}/BrowserLauncher2/License.BrowserLauncher2" tofile="${dist.temp.jars}/BrowserLauncher2/BrowserLauncher2-license.txt"/>

	<antcall target='copy-thirdparty'>
		<param name='directory' value='commons-lang3/3.1' />
		<param name='filename' value='commons-lang3-3.1-sources.jar' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='commons-lang3/3.1' />
		<param name='filename' value='commons-lang3-3.1.jar' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='commons-lang3/3.1' />
		<param name='filename' value='LICENSE.txt' />
	</antcall>
	<move file="${dist.temp.jars}/commons-lang3/3.1/LICENSE.txt" tofile="${dist.temp.jars}/commons-lang3/ApacheCommons-license.txt"/>

	<antcall target='copy-thirdparty'>
		<param name='directory' value='jcalendar-1.3.2' />
		<param name='filename' value='jcalendar-1.3.2-src.zip' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jcalendar-1.3.2' />
		<param name='filename' value='jcalendar-1.3.2.jar' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jcalendar-1.3.2' />
		<param name='filename' value='LICENSE.jcalendar' />
	</antcall>
	<move file="${dist.temp.jars}/jcalendar-1.3.2/LICENSE.jcalendar" tofile="${dist.temp.jars}/jcalendar-1.3.2/jcalendar-license.txt"/>

	<antcall target='copy-thirdparty'>
		<param name='directory' value='jgraph' />
		<param name='filename' value='miradi-jgraph-5.12.2.2b-src.zip' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jgraph' />
		<param name='filename' value='miradi-jgraph-5.12.2.2b.jar' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jgraph' />
		<param name='filename' value='LICENSE.jgraph' />
	</antcall>
	<move file="${dist.temp.jars}/jgraph/LICENSE.jgraph" tofile="${dist.temp.jars}/jgraph/jgraph-license.txt"/>

	<antcall target='copy-thirdparty'>
		<param name='directory' value='jhlabs' />
		<param name='filename' value='layouts.zip' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jhlabs' />
		<param name='filename' value='LICENSE.TXT' />
	</antcall>

	<antcall target='copy-thirdparty'>
		<param name='directory' value='jing' />
		<param name='filename' value='jing-src-20091111.zip' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jing' />
		<param name='filename' value='LICENSE xerces.copying.txt' />
	</antcall>
	<move file="${dist.temp.jars}/jing/LICENSE xerces.copying.txt" tofile="${dist.temp.jars}/jing/xerces-license.txt"/>
	
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jing' />
		<param name='filename' value='LICENSE-jing.txt' />
	</antcall>
	<move file="${dist.temp.jars}/jing/LICENSE-jing.txt" tofile="${dist.temp.jars}/jing/jing-license.txt"/>
	
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jing' />
		<param name='filename' value='readme.html' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jing/bin' />
		<param name='filename' value='isorelax.jar' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jing/bin' />
		<param name='filename' value='jing.jar' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jing/bin' />
		<param name='filename' value='saxon.jar' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jing/bin' />
		<param name='filename' value='xercesImpl.jar' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jing/bin' />
		<param name='filename' value='xml-apis.jar' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jing/lib' />
		<param name='filename' value='mns.rng' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jing/lib' />
		<param name='filename' value='nrl.rng' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jing/lib' />
		<param name='filename' value='relaxCore.rng' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jing/lib' />
		<param name='filename' value='relaxCoreDatatypes.rng' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jing/lib' />
		<param name='filename' value='relaxng.rnc' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jing/lib' />
		<param name='filename' value='relaxng.rng' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jing/lib' />
		<param name='filename' value='schematron.rnc' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jing/lib' />
		<param name='filename' value='xslt.rng' />
	</antcall>

	<antcall target='copy-thirdparty'>
		<param name='directory' value='jtreetable' />
		<param name='filename' value='license.txt' />
	</antcall>

	<antcall target='copy-thirdparty'>
		<param name='directory' value='JUnit/bin' />
		<param name='filename' value='junit.jar' />
	</antcall>

	<antcall target='copy-thirdparty'>
		<param name='directory' value='martus-swing/bin' />
		<param name='filename' value='martus-swing.jar' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='martus-swing/source' />
		<param name='filename' value='martus-swing-src.jar' />
	</antcall>
	
	<antcall target='copy-thirdparty'>
			<param name='directory' value='martus-swing' />
			<param name='filename' value='martus-swing-license.txt' />
		</antcall>
	
	<antcall target='copy-thirdparty'>
		<param name='directory' value='martus-utils/bin' />
		<param name='filename' value='martus-utils.jar' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='martus-utils/source' />
		<param name='filename' value='martus-utils-src.jar' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='martus-utils' />
		<param name='filename' value='martus-utils-license.txt' />
	</antcall>
	
	<antcall target='copy-thirdparty'>
		<param name='directory' value='swingx/0.9.7' />
		<param name='filename' value='swingx-0.9.7.jar' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='swingx/0.9.7' />
		<param name='filename' value='swingx-0.9.7-src.zip' />
	</antcall>
	<antcall target='copy-thirdparty'>
			<param name='directory' value='swingx/0.9.7' />
			<param name='filename' value='COPYING' />
	</antcall>
	<move file="${dist.temp.jars}/swingx/0.9.7/COPYING" tofile="${dist.temp.jars}/swingx/0.9.7/swingx-license.txt"/>

	<antcall target='copy-thirdparty'>
		<param name='directory' value='jortho/bin' />
		<param name='filename' value='jortho.jar' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jortho/lib' />
		<param name='filename' value='JOrtho_0.5.zip' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jortho' />
		<param name='filename' value='license-jortho.txt' />
	</antcall>
	<move file="${dist.temp.jars}/jortho/license-jortho.txt" tofile="${dist.temp.jars}/jortho/jortho-license.txt"/>
	
	<antcall target='copy-thirdparty'>
		<param name='directory' value='jortho/lib' />
		<param name='filename' value='dictionary_en_2009_01.zip' />
	</antcall>
	<unzip src='${dist.temp.jars}/jortho/lib/dictionary_en_2009_01.zip' dest='${dist.temp}'>
		<patternset>
			<include name="**/*.ortho"/>
		</patternset>
	</unzip>

	<antcall target='copy-thirdparty'>
		<param name='directory' value='shef/0.5' />
		<param name='filename' value='shef.jar' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='shef/0.5' />
		<param name='filename' value='LICENSE-shef.txt' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='shef/0.5' />
		<param name='filename' value='shef-src.zip' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='shef/0.5' />
		<param name='filename' value='sam.jar' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='shef/0.5' />
		<param name='filename' value='LICENSE-sam.txt' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='shef/0.5' />
		<param name='filename' value='sam-src.jar' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='shef/0.5' />
		<param name='filename' value='jtidy-8.0.jar' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='shef/0.5' />
		<param name='filename' value='LICENSE-jtidy.txt' />
	</antcall>
	<antcall target='copy-thirdparty'>
		<param name='directory' value='shef/0.5' />
		<param name='filename' value='jtidy-src.zip' />
	</antcall>
</target>

<!-- ================================================================== -->
<!-- C U S T O M  T A S K   D E S                                       -->
<!-- ================================================================== -->
<taskdef name="jarbundler"
         classname="net.sourceforge.jarbundler.JarBundler"
         classpath="${installer.mac.dir}/jarbundler-2.3.1/build/jarbundler-2.3.1.jar" />

<taskdef name="install4j"
         classname="com.install4j.Install4JTask"
         classpath="${env.INSTALL4J.INSTALL.PATH}\ant.jar"/>

<!-- ================================================================== -->
<!-- Z I P S                                                            -->
<!-- ================================================================== -->
<target name='zips' depends='ThirdParty, jar' description='Create Linux/Mac Zip Files'>
	<property name='JarFolder' value='ThirdParty'/>
	
    <zip destfile="${dist.dir}/Miradi-Linux.zip">
		<zipfileset dir="${installer.buildfiles.dir}" includes="README.txt"/>
		<zipfileset dir="${installer.buildfiles.dir}" includes="LICENSE.txt"/>
		<zipfileset dir="${installer.buildfiles.dir}" includes="LicenseOverview.txt"/>
    	<zipfileset dir="${dist.dir}" includes="miradi.jar"/>
		<zipfileset dir="${installer.buildfiles.dir}" includes="${samples.marine.miradi}" />
    	
    	<!-- ThirdParty jars -->
    	<zipfileset dir="${dist.temp.jars}/BrowserLauncher2/" prefix='${JarFolder}' includes="BrowserLauncher*.jar" />
    	<zipfileset dir="${dist.temp.jars}/BrowserLauncher2/" prefix='${JarFolder}' includes="BrowserLauncher2-license.txt" />
    	<zipfileset dir="${dist.temp.jars}/commons-lang3/3.1/" prefix="${JarFolder}" includes="commons-lang3-3.1.jar" />
    	<zipfileset dir="${dist.temp.jars}/commons-lang3/" prefix="${JarFolder}" includes="ApacheCommons-license.txt" />
    	<zipfileset dir="${dist.temp.jars}/jcalendar-1.3.2/" prefix='${JarFolder}' includes="jcalendar*.jar" />
    	<zipfileset dir="${dist.temp.jars}/jcalendar-1.3.2/" prefix='${JarFolder}' includes="jcalendar-license.txt" />
    	<zipfileset dir="${dist.temp.jars}/jgraph/" prefix='${JarFolder}' includes="miradi-jgraph-5.12.2.2b.jar" />
    	<zipfileset dir="${dist.temp.jars}/jgraph/" prefix='${JarFolder}' includes="jgraph-license.txt" />
    	<zipfileset dir="${dist.temp.jars}/martus-utils/bin/" prefix='${JarFolder}' includes="martus-utils.jar" />
    	<zipfileset dir="${dist.temp.jars}/martus-utils/" prefix='${JarFolder}' includes="martus-utils-license.txt" />
       	<zipfileset dir="${dist.temp.jars}/martus-swing/bin/" prefix='${JarFolder}' includes="martus-swing.jar" />
    	<zipfileset dir="${dist.temp.jars}/martus-swing/" prefix='${JarFolder}' includes="martus-swing-license.txt" />
        <zipfileset dir="${dist.temp.jars}/jing/bin/" prefix='${JarFolder}' includes="jing.jar" />
    	<zipfileset dir="${dist.temp.jars}/jing/" prefix='${JarFolder}' includes="jing-license.txt" />
    	<zipfileset dir="${dist.temp.jars}/jing/" prefix='${JarFolder}' includes="xerces-license.txt" />
        <zipfileset dir="${dist.temp.jars}/swingx/0.9.7/" prefix='${JarFolder}' includes="swingx-0.9.7.jar" />
    	<zipfileset dir="${dist.temp.jars}/swingx/0.9.7/" prefix='${JarFolder}' includes="swingx-license.txt" />
    	<zipfileset dir="${dist.temp.jars}/jortho/bin/" prefix='${JarFolder}' includes="*.jar"/>
    	<zipfileset dir="${dist.temp.jars}/jortho/" prefix='${JarFolder}' includes="jortho-license.txt"/>
    	<zipfileset dir="${dist.temp.jars}/shef/0.5/" prefix="${JarFolder}" includes="shef.jar" />
    	<zipfileset dir="${dist.temp.jars}/shef/0.5/" prefix="${JarFolder}" includes="LICENSE-shef.txt" />
    	<zipfileset dir="${dist.temp.jars}/shef/0.5/" prefix="${JarFolder}" includes="sam.jar" />
       	<zipfileset dir="${dist.temp.jars}/shef/0.5/" prefix="${JarFolder}" includes="LICENSE-sam.txt" />
       	<zipfileset dir="${dist.temp.jars}/shef/0.5/" prefix="${JarFolder}" includes="jtidy-8.0.jar" />
        <zipfileset dir="${dist.temp.jars}/shef/0.5/" prefix="${JarFolder}" includes="LICENSE-jtidy.txt" />
    </zip>

	<!-- Third-party source code -->
	<zip destfile="${dist.dir}/Miradi-Thirdparty-Source.zip">
    	<zipfileset dir="${dist.temp.jars}/BrowserLauncher2/" prefix='source' includes="BrowserLauncher2-all-10rc4.jar" />
    	<zipfileset dir="${dist.temp.jars}/commons-lang3/3.1/" prefix="source" includes="commons-lang3-3.1-sources.jar" />
    	<zipfileset dir="${dist.temp.jars}/jcalendar-1.3.2/" prefix='source' includes="jcalendar-1.3.2-src.zip" />
    	<zipfileset dir="${dist.temp.jars}/jgraph/" prefix='source' includes="miradi-jgraph-5.12.2.2b-src.zip" />
    	<zipfileset dir="${dist.temp.jars}/martus-swing/source/" prefix='source' includes="martus-swing-src.jar" />
		<zipfileset dir="${dist.temp.jars}/martus-utils/source/" prefix='source' includes="martus-utils-src.jar" />
    	<zipfileset dir="${dist.temp.jars}/jing/" prefix='source' includes="jing-src*.zip" />
    	<zipfileset dir="${dist.temp.jars}/swingx/0.9.7" prefix="source" includes="swingx-0.9.7-src.zip" />
		<zipfileset dir="${dist.temp.jars}/jortho/" prefix="source" includes="**/JOrtho*.zip" />
		<zipfileset dir="${dist.temp.jars}/jortho/" prefix="source" includes="**/dictionary*.zip" />
    	<zipfileset dir="${dist.temp.jars}/shef/0.5/" prefix="source" includes="shef-src.jar" />
    	<zipfileset dir="${dist.temp.jars}/shef/0.5/" prefix="source" includes="sam-src.jar" />
    	<zipfileset dir="${dist.temp.jars}/shef/0.5/" prefix="source" includes="jtidy-src.zip" />
	</zip>
	
	<copy file="${installer.buildfiles.dir}/${samples.marine.miradi}" todir="${dist.dir}" />
	<copy file="${installer.buildfiles.dir}/README.txt" todir="${dist.dir}" />
</target>
	
<!-- ================================================================== -->
<!-- P O T                                            -->
<!-- ================================================================== -->
<target name="pot" depends="init" description="Create Translatable POT file">
	<property name="java_files" value="${dist.dir}/java_files.txt"/>
	<mkdir dir="${dist.dir}" />
		
	<!-- Required for all languages -->
	<echo message="build list of all files that contain translatable strings"/>
	<echo message="Writing list of java files in ${eam.src.root} to ${java_files}..." />
	<exec executable="find" output="${java_files}" failonerror="true">
		<arg value="${eam.src.root}"/>
		<arg value="-name"/>
		<arg value="*.java"/>
	</exec>
	<echo message="extract code text strings to pot file"/>
	<exec executable="xgettext" failonerror="true">
		<arg value="--language=java"/>
		<arg value="--from-code=UTF-8"/>
		<arg value="--sort-output"/>
		<arg value="--keyword"/>
		<arg value="--keyword=EAM.text"/>
		<arg value="--copyright-holder=Benetech"/>
		<arg value="--output=${miradi.pot}"/>
		<arg value="--files-from=${java_files}"/>
	</exec>
	<!-- Hopefully abort if there are non-UTF-8 characters in the pot -->
	<exec executable="iconv" failonerror="true" output="/dev/null">
		<arg value="${miradi.pot}"/>
	</exec>
	<delete file="${java_files}"/>
	<echo message="append FieldLabels.properties strings to pot file"/>
	<exec executable="ruby" failonerror="true">
		<arg value="${build.dir}/AddFieldLabelsToPOT.rb"/>
		<arg value="${eam.fieldlabels.properties}"/>
		<arg value="${miradi.pot}"/>
	</exec>
	<echo message="append each HTML file as an entry in the pot file"/>
	<exec executable="ruby" failonerror="true">
		<arg value="${build.dir}/AddHtmlFilesToPOT.rb"/>
		<arg value="${eam.src.root}"/>
		<arg value="${miradi.pot}"/>
	</exec>
	<echo message="append each fieldoptions choice as an entry in the pot file"/>
	<exec executable="ruby" failonerror="true">
		<arg value="${build.dir}/AddChoicesToPOT.rb"/>
		<arg value="${eam.src.root}"/>
		<arg value="${miradi.pot}"/>
	</exec>
</target>

<!-- ================================================================== -->
<!-- CREATE NEW PO                                            -->
<!--   
	NOTE: You can only create ONE po file at a time
	1. Create the new po property at the top of this file
	2. Add the new language to the dependencies of the translations target
	3. Insert three lines like this	at the start of the new language target:	
		<property name="po.locale" value="XXX" />
		<property name="po.file" value="${miradi.po.xxx}" />
		<antcall target="create-new-po"/>
		
	4. Allow the build to run
	5. The new PO file should be in your workspace next time you sync and pull
	6. Delete the three lines of code mentioned above
	7. Manually edit the PO headers as needed, and re-commit
-->
<!-- ================================================================== -->
<target name="create-new-po" description="Create empty po file">
	<!--suppress AntResolveInspection -->
    <echo message="Creating po file: ${po.locale} ${po.file}"/>
	<exec executable="msginit" failonerror="true">
		<arg value="--no-translator"/>
		<arg value="--input=${miradi.pot}"/>
		<arg value="--output-file=${po.file}"/>
		<!--suppress AntResolveInspection -->
        <arg value="--locale=${po.locale}"/>
	</exec>
	<echo message="Updating PO to UTF-8"/>
	<exec executable="sed" failonerror="true">
		<arg value="--in-place" />
		<arg value='s/^"Content-Type:.*$/"Content-Type: text\/plain; charset=UTF-8\\n"/'/>
		<arg value="${po.file}" />
	</exec>
</target>

<!-- ================================================================== -->
<!-- C H I N E S E                   -->
<!-- ================================================================== -->
<target name="chinese" depends="pot" description="Update Chinese Content">
	<antcall target="update-po">
		<param name="po.file" value="${miradi.po.zh}"/>
		<param name="language.code" value="zh"/>
	</antcall>
</target>
	
<!-- ================================================================== -->
<!-- FRENCH                                                             -->
<!-- ================================================================== -->
<target name="french" depends="pot" description="Update French Content">
	<antcall target="update-po">
		<param name="po.file" value="${miradi.po.fr}"/>
		<param name="language.code" value="fr"/>
	</antcall>
</target>
		
<!-- ================================================================== -->
<!-- GERMAN                                                             -->
<!-- ================================================================== -->
<target name="german" depends="pot" description="Update German Content">
	<antcall target="update-po">
		<param name="po.file" value="${miradi.po.de}"/>
		<param name="language.code" value="de"/>
	</antcall>
</target>
			
<!-- ================================================================== -->
<!-- HEBREW                                            -->
<!-- ================================================================== -->
<target name="hebrew" depends="pot" description="Update Hebrew Content">
	<antcall target="update-po">
		<param name="po.file" value="${miradi.po.he}"/>
		<param name="language.code" value="he"/>
	</antcall>
</target>
	
<!-- ================================================================== -->
<!-- HUNGARIAN                                                          -->
<!-- ================================================================== -->
<target name="hungarian" depends="pot" description="Update Hungarian Content">
	<antcall target="update-po">
		<param name="po.file" value="${miradi.po.hu}"/>
		<param name="language.code" value="hu"/>
	</antcall>
</target>

<!-- ================================================================== -->
<!-- I N D O N E S I A N                   -->
<!-- ================================================================== -->
<target name="indonesian" depends="pot" description="Update Indonesian Content">
	<antcall target="update-po">
		<param name="po.file" value="${miradi.po.id}"/>
		<param name="language.code" value="id"/>
	</antcall>
</target>
	
<!-- ================================================================== -->
<!-- ITALIAN                   -->
<!-- ================================================================== -->
<target name="italian" depends="pot" description="Update Italian Content">
<antcall target="update-po">
	<param name="po.file" value="${miradi.po.it}"/>
	<param name="language.code" value="it"/>
</antcall>
</target>

<!-- ================================================================== -->
<!-- MALAGASY (PLATEAU)                                            -->
<!-- ================================================================== -->
<target name="malagasy" depends="pot" description="Update Malagasy Content">
<antcall target="update-po">
	<param name="po.file" value="${miradi.po.plt}"/>
	<param name="language.code" value="plt"/>
</antcall>
</target>

<!-- ================================================================== -->
<!-- MONGOLIAN (CYRILLIC SCRIPT)                   -->
<!-- ================================================================== -->
<target name="mongolian" depends="pot" description="Update Mongolian Content">
<antcall target="update-po">
	<param name="po.file" value="${miradi.po.mn}"/>
	<param name="language.code" value="mn"/>
</antcall>
</target>

<!-- ================================================================== -->
<!-- PORTUGUESE                                                         -->
<!-- ================================================================== -->
<target name="portuguese" depends="pot" description="Update Portuguese Content">
<antcall target="update-po">
	<param name="po.file" value="${miradi.po.pt}"/>
	<param name="language.code" value="pt"/>
</antcall>
</target>

<!-- ================================================================== -->
<!-- PSP (English, but with some terms substituted                      -->
<!-- ================================================================== -->
<target name="psp-langpack" depends="pot" description="Update PSP Language Pack Content">
<antcall target="update-po">
	<param name="po.file" value="${miradi.po.psp}"/>
	<param name="language.code" value="psp"/>
</antcall>
</target>

<!-- ================================================================== -->
<!-- S P A N I S H                                            -->
<!-- ================================================================== -->
<target name="spanish" depends="pot" description="Update Spanish Content">
	<antcall target="update-po">
		<param name="po.file" value="${miradi.po.es}"/>
		<param name="language.code" value="es"/>
	</antcall>
</target>
	
<!-- ================================================================== -->
<!-- UKRAINIAN                   -->
<!-- ================================================================== -->
<target name="ukrainian" depends="pot" description="Update Ukrainian Content">
	<antcall target="update-po">
		<param name="po.file" value="${miradi.po.uk}"/>
		<param name="language.code" value="uk"/>
	</antcall>
</target>

<!-- ================================================================== -->
<!-- USAID Project (English, but with some terms substituted)           -->
<!-- ================================================================== -->
<target name="usaid-project-langpack" depends="pot" description="Update USAID Project Language Pack Content">
    <antcall target="update-po">
        <param name="po.file" value="${miradi.po.aid}"/>
        <param name="language.code" value="aid"/>
    </antcall>
</target>
	
<!-- ================================================================== -->
<!-- UPDATE PO CONTENTS                                            -->
<!-- ================================================================== -->
<target name="update-po" description="Update ${po.file}">
	<echo message="updating ${po.file}"/>
	<exec executable="msgmerge" failonerror="true">
		<arg value="--update"/>
		<arg value="--backup=none"/>
		<arg value="--no-fuzzy-matching"/>
		<arg value="${po.file}"/>
		<arg value="${miradi.pot}"/>
	</exec>
	<echo message="building ${language.code} content jar"/>
	<zip destfile="${dist.dir}/MiradiContent-${version.langpack}-${language.code}.jar">
        <fileset dir="${eam.src.root}" includes="**/*.jpg"/>
        <fileset dir="${eam.src.root}" includes="**/*.png"/>
        <fileset dir="${eam.src.root}" includes="**/*.gif"/>
		<fileset dir="${translations.dir}" includes="miradi_${language.code}.po"/>
	</zip>
</target>

<!-- ================================================================== -->
<!-- T R A N S L A T I O N S                                            -->
<!-- ================================================================== -->
<target name="translations" 
	depends="pot, chinese, french, german, hebrew, hungarian, indonesian, italian, malagasy, mongolian, portuguese, psp-langpack, spanish, ukrainian, usaid-project-langpack"
	description="Create Translatable Content jars/zips">

	<!-- Add any new translation files -->	
	<exec executable="hg" failonerror="false" dir="${miradi.root.dir}" >
		<arg value="add"/>
		<arg value="${translations.subdir}"/>
	</exec>

	<!-- See if there is anything to commit -->
	<exec executable="hg" failonerror="true" dir="${translations.dir}" outputproperty="output">
		<arg value="status"/>
	</exec>
	<condition property="FilesWereModified">
		<length string="${output}" trim="true" when="greater" length="0" />
	</condition>
	<antcall target="CommitTranslations" />
</target>

<target name="CommitTranslations" if="FilesWereModified">
	<echo message="Committing translations" />
	<exec executable="hg" failonerror="true" dir="${miradi.root.dir}">
		<arg value="commit" />
		<arg value="--message" />
		<arg value="Updated PO files: ${version.timestamp}" />
	</exec>
	<exec executable="hg" failonerror="true" dir="${miradi.root.dir}">
		<arg value="--config" />
		<arg value="auth.google.prefix=${source.hg.miradi-client}" />
		<arg value="--config" />
		<arg value="auth.google.username=${source.hg.username}"/>
		<arg value="--config" />
		<arg value="auth.google.password=${source.hg.password}" />
		<arg value="push" />
		<arg value="-r" />
		<arg value="." />
	</exec>
</target>
	
<!-- ================================================================== -->
<!-- S O U R C E                                                        -->
<!-- ================================================================== -->
<target name="source" depends="init" description="Create Source zip">
	<echo message="building Mirad-Source.zip"/>
	<zip destfile="${dist.dir}/Miradi-Source.zip">
		<zipfileset dir="${eam.src.root}/" prefix='Miradi-${version.full}' includes="**/*" excludes=".svn" />
		<zipfileset dir="${installer.buildfiles.dir}" includes="README.txt"/>
		<zipfileset dir="${installer.buildfiles.dir}" includes="LICENSE.txt"/>
		<zipfileset dir="${installer.buildfiles.dir}" includes="LicenseOverview.txt"/>
		<zipfileset dir="${build.dir}" includes='build.xml'/>
	</zip>
</target>

<!-- ================================================================== -->
<!-- M A C   A P P   B U N D L E                                        -->
<!-- ================================================================== -->
<target name="macappbundle" depends="" description="create a jar app bundle for the mac">
	<property name="macjavastubfile" value="${installer.mac.dir}/JavaApplicationStub/JavaApplicationStub" />

	<mkdir dir="${dist.mactree}" />
	<delete>
		<fileset dir="${dist.mactree}" includes="*" />
	</delete>

    <jarbundler
		dir="${dist.mactree}"
		name="${mac.app.name}" 
		mainclass="org.miradi.main.Miradi" 
		jvmversion="1.6+"
		stubfile="${macjavastubfile}" 
		shortname="Miradi" 
		version="${version.full}"
		build="${version.timestamp}"
		vmoptions="-Xmx512m"
        icon="${eam.icons}/miradi.icns"
		>

		<jarfileset dir="${dist.dir}">
			<include name="miradi.jar" />
		</jarfileset>
		<jarfileset dir="${dist.temp.jars}/">
			<include name="**/*.jar" />
			<exclude name="junit*" />
		</jarfileset>

		<javaproperty name="apple.laf.useScreenMenuBar" value="true" />
		<javaproperty name="apple.awt.brushMetal" value="true" />
		<javaproperty name="apple.awt.showGrowBox" value="true" />
		<javaproperty name="apple.awt.antialiasing" value="true" />
		<javaproperty name="apple.awt.textantialiasing" value="true" />
	</jarbundler>

    <copy todir="${dist.mactree}">
        <fileset dir="${installer.mac.dmgbuild.dir}">
            <include name="**/*.*" />
        </fileset>
    </copy>

</target>

<!-- ================================================================== -->
<!-- M A C   D M G   F I L E                                            -->
<!-- ================================================================== -->
<target name="macdmgfile" depends="macappbundle" description="create a mac dmg file" if="isLinux">
    <property name="mac.build.temp.dir" value="/Users/${mac.build.user}/miradi-build-temp" />
    <property name="mac.dmgbuild.settings" value="settings.py" />
    <property name="mac.dmgbuild.background" value="background.png" />
    <property name="mac.build.dmg" value="Miradi-${version.full}.dmg" />
    <property name="mac.build.dmg.name" value="Miradi ${version.full} Mac Install" />

    <!-- delete / create temp folder on mac build machine -->
    <echo message="Creating ${mac.build.temp.dir} folder on ${mac.build.user}@${mac.build.server}" />
    <exec executable="ssh" failonerror="true">
        <arg value="${mac.build.user}@${mac.build.server}"/>
        <arg value="rm -rf ${mac.build.temp.dir};
                    mkdir ${mac.build.temp.dir};
                    exit;"/>
    </exec>

    <!-- copy over necessary files -->
    <echo message="Copying files to ${mac.build.user}@${mac.build.server}:${mac.build.temp.dir}" />
    <exec executable="scp" failonerror="true">
        <arg value="-r"/>
        <arg value="${dist.mactree}/${mac.app.name}.app"/>
        <arg value="${dist.mactree}/${mac.dmgbuild.settings}"/>
        <arg value="${dist.mactree}/${mac.dmgbuild.background}"/>
        <arg value="${installer.buildfiles.dir}/README.txt"/>
        <arg value="${installer.buildfiles.dir}/LICENSE.txt"/>
        <arg value="${installer.buildfiles.dir}/${samples.marine.miradi}" />
        <arg value="${mac.build.user}@${mac.build.server}:${mac.build.temp.dir}"/>
    </exec>

    <!-- ssh to mac build machine and sign app, exec dmgbuild to create dmg -->
    <echo message="Signing ${mac.app.name}.app and building ${mac.build.dmg}" />
    <exec executable="ssh" failonerror="true">
        <arg value="${mac.build.user}@${mac.build.server}"/>
        <arg value="cd ${mac.build.temp.dir};
                    security unlock-keychain -p ${mac.build.password};
                    codesign -s ${mac.build.certname} -f ${mac.build.temp.dir}/${mac.app.name}.app;
                    dmgbuild -s ${mac.dmgbuild.settings} -D app=${mac.app.name}.app '${mac.build.dmg.name}' ${mac.build.dmg};
                    exit;"/>
    </exec>

    <!-- copy back over built dmg -->
    <echo message="Copying ${mac.build.user}@${mac.build.server}:${mac.build.temp.dir}/${mac.build.dmg} to ${dist.dir}/${mac.build.dmg}" />
    <exec executable="scp" failonerror="true">
        <arg value="${mac.build.user}@${mac.build.server}:${mac.build.temp.dir}/${mac.build.dmg}"/>
        <arg value="${dist.dir}/${mac.build.dmg}"/>
    </exec>

    <!-- delete temp folder on mac build machine -->
    <echo message="Deleting ${mac.build.temp.dir} on ${mac.build.user}@${mac.build.server}" />
    <exec executable="ssh" failonerror="true">
        <arg value="${mac.build.user}@${mac.build.server}"/>
        <arg value="rm -rf ${mac.build.temp.dir};
                    exit;"/>
    </exec>

	<delete dir="${dist.mactree}" />
</target>

<!-- ================================================================== -->
<!-- win32installer                                                    -->
<!-- ================================================================== -->
<target name="win32installer" depends="jar" description="Windows install4j installer build">
    <install4j projectfile="${build.dir}/miradi.install4j">
        <variable name="version.full" value="${version.full}"/>
        <variable name="dist.dir" value="${dist.dir}"/>
        <variable name="dist.temp.jars" value="${dist.temp.jars}"/>
        <variable name="jres.path" value="${env.INSTALL4J.JRES.PATH}"/>
    </install4j>
</target>

<!-- ================================================================== -->
<!-- permissions                                                        -->
<!-- ================================================================== -->
<target name="permissions" depends="" description="Modify permissions on built output">
    <chmod file="${dist.dir}/**" perm="g+w" type="both" parallel="false"/>
</target>

<!-- ================================================================== -->
<!-- R E L E A S E                                                      -->
<!-- ================================================================== -->
<target name="release" depends="translations, source, zips, macdmgfile, win32installer, cleanup, permissions">
    <echo message="Release Built"/>
    <echo message="REMEMBER TO TAG THIS RELEASE WITH ${version.timestamp} !"/>
</target>

</project>
